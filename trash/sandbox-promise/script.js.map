{
  "version": 3,
  "sources": ["../../../static/root/trash/sandbox-promise/script.js"],
  "sourcesContent": ["// @process\n\n// =================================\n\nclass CancelError extends Error {\n  constructor(message) {\n    super(message); // (1)\n    this.name = 'CancelError'; // (2)\n  }\n}\n\nfunction makeRequest(method, url) {\n  const xhr = new XMLHttpRequest();\n\n  const req = new Promise((resolve, reject) => {\n    xhr.open(method, url);\n    xhr.onload = function () {\n      if (this.status >= 200 && this.status < 300) {\n        resolve(JSON.parse(xhr.response));\n      } else {\n        reject(new Error('Response status error'));\n      }\n    };\n    xhr.onerror = function () {\n      reject(new Error('Network error'));\n    };\n\n    xhr.addEventListener('abort', () => {\n      reject(new CancelError('Canceled'));\n    });\n\n    xhr.send();\n  });\n\n  req.cancel = () => {\n    xhr.abort();\n  };\n\n  return req;\n}\n\nconst getResult = (value) => value;\n\n// =================================\n\nconst inputEl = document.querySelector('#input');\nconst resultEl = document.querySelector('#result');\n\nconst showResult = (val) => {\n  resultEl.innerHTML = val;\n};\n\ninputEl.addEventListener('input', (e) => {\n  showResult(e.target.value);\n});\n\n// =================================\n// SIMPLE\n// =================================\n\nlet req;\ndocument.querySelector('#start').addEventListener('click', async () => {\n  req = makeRequest('GET', '/api/test1.do');\n  const data = await req;\n\n  showResult(data.result);\n});\n\ndocument.querySelector('#stop').addEventListener('click', async () => {\n  req.cancel();\n});\n\n// =================================\n// COMPLEX\n// =================================\n\nconst cancelablePromise = (func) => {\n  const reqObj = { req: undefined };\n  const promise = func(reqObj);\n\n  promise.cancel = () => {\n    try {\n      reqObj.req.cancel();\n    } catch (e) {\n      //\n    }\n  };\n\n  return promise;\n};\n\nlet promiseResult;\nconst doComplexShit = async () => {\n  try {\n    // \u041E\u0442\u043C\u0435\u043D\u044F\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u0437\u0430\u043F\u0440\u043E\u0441\u044B\n    if (promiseResult) {\n      promiseResult.cancel();\n    }\n\n    // \u0428\u043B\u0435\u043C \u043D\u043E\u0432\u044B\u0435 \u0437\u0430\u043F\u0440\u043E\u0441\u044B \u043F\u043E \u043E\u0447\u0435\u0440\u0435\u0434\u0438\n\n    promiseResult = cancelablePromise((reqObj) =>\n      (async () => {\n        reqObj.req = makeRequest('GET', '/api/test1.do');\n        const data1 = await reqObj.req;\n\n        reqObj.req = makeRequest('GET', '/api/test2.do');\n        const data2 = await reqObj.req;\n\n        return `cr=${data1.result}${data2.result}`;\n      })(),\n    );\n    await promiseResult;\n\n    promiseResult = cancelablePromise((reqObj) =>\n      (async () => {\n        reqObj.req = makeRequest('GET', '/api/test1.do');\n        const data1 = await reqObj.req;\n\n        reqObj.req = makeRequest('GET', '/api/test2.do');\n        const data2 = await reqObj.req;\n\n        return `cr=${data1.result}${data2.result}`;\n      })(),\n    );\n    await promiseResult;\n  } catch (e) {\n    if (e instanceof CancelError) {\n      console.log('canceled');\n      return 123;\n    }\n    throw e;\n  }\n};\n\ndocument.querySelector('#start-complex').addEventListener('click', async () => {\n  try {\n    const data = await doComplexShit();\n    // console.log('NOT ERROR', data);\n  } catch (e) {\n    console.warn(e);\n  }\n\n  // showResult(data);\n});\n\ndocument.querySelector('#stop-complex').addEventListener('click', async () => {\n  promiseResult.cancel();\n});\n"],
  "mappings": "AAIA,IAAMA,EAAN,cAA0B,KAAM,CAC9B,YAAYC,EAAS,CACnB,MAAMA,CAAO,EACb,KAAK,KAAO,aACd,CACF,EAEA,SAASC,EAAYC,EAAQC,EAAK,CAChC,IAAMC,EAAM,IAAI,eAEVC,EAAM,IAAI,QAAQ,CAACC,EAASC,IAAW,CAC3CH,EAAI,KAAKF,EAAQC,CAAG,EACpBC,EAAI,OAAS,UAAY,CACnB,KAAK,QAAU,KAAO,KAAK,OAAS,IACtCE,EAAQ,KAAK,MAAMF,EAAI,QAAQ,CAAC,EAEhCG,EAAO,IAAI,MAAM,uBAAuB,CAAC,CAE7C,EACAH,EAAI,QAAU,UAAY,CACxBG,EAAO,IAAI,MAAM,eAAe,CAAC,CACnC,EAEAH,EAAI,iBAAiB,QAAS,IAAM,CAClCG,EAAO,IAAIR,EAAY,UAAU,CAAC,CACpC,CAAC,EAEDK,EAAI,KAAK,CACX,CAAC,EAED,OAAAC,EAAI,OAAS,IAAM,CACjBD,EAAI,MAAM,CACZ,EAEOC,CACT,CAMA,IAAMG,EAAU,SAAS,cAAc,QAAQ,EACzCC,EAAW,SAAS,cAAc,SAAS,EAE3CC,EAAcC,GAAQ,CAC1BF,EAAS,UAAYE,CACvB,EAEAH,EAAQ,iBAAiB,QAAU,GAAM,CACvCE,EAAW,EAAE,OAAO,KAAK,CAC3B,CAAC,EAMD,IAAIE,EACJ,SAAS,cAAc,QAAQ,EAAE,iBAAiB,QAAS,SAAY,CACrEA,EAAMC,EAAY,MAAO,eAAe,EACxC,IAAMC,EAAO,MAAMF,EAEnBF,EAAWI,EAAK,MAAM,CACxB,CAAC,EAED,SAAS,cAAc,OAAO,EAAE,iBAAiB,QAAS,SAAY,CACpEF,EAAI,OAAO,CACb,CAAC,EAMD,IAAMG,EAAqBC,GAAS,CAClC,IAAMC,EAAS,CAAE,IAAK,MAAU,EAC1BC,EAAUF,EAAKC,CAAM,EAE3B,OAAAC,EAAQ,OAAS,IAAM,CACrB,GAAI,CACFD,EAAO,IAAI,OAAO,CACpB,OAASE,EAAP,CAEF,CACF,EAEOD,CACT,EAEIE,EACEC,EAAgB,SAAY,CAChC,GAAI,CAEED,GACFA,EAAc,OAAO,EAKvBA,EAAgBL,EAAmBE,IAChC,SAAY,CACXA,EAAO,IAAMJ,EAAY,MAAO,eAAe,EAC/C,IAAMS,EAAQ,MAAML,EAAO,IAE3BA,EAAO,IAAMJ,EAAY,MAAO,eAAe,EAC/C,IAAMU,EAAQ,MAAMN,EAAO,IAE3B,MAAO,MAAMK,EAAM,SAASC,EAAM,QACpC,GAAG,CACL,EACA,MAAMH,EAENA,EAAgBL,EAAmBE,IAChC,SAAY,CACXA,EAAO,IAAMJ,EAAY,MAAO,eAAe,EAC/C,IAAMS,EAAQ,MAAML,EAAO,IAE3BA,EAAO,IAAMJ,EAAY,MAAO,eAAe,EAC/C,IAAMU,EAAQ,MAAMN,EAAO,IAE3B,MAAO,MAAMK,EAAM,SAASC,EAAM,QACpC,GAAG,CACL,EACA,MAAMH,CACR,OAAS,EAAP,CACA,GAAI,aAAaI,EACf,eAAQ,IAAI,UAAU,EACf,IAET,MAAM,CACR,CACF,EAEA,SAAS,cAAc,gBAAgB,EAAE,iBAAiB,QAAS,SAAY,CAC7E,GAAI,CACF,IAAMV,EAAO,MAAMO,EAAc,CAEnC,OAAS,EAAP,CACA,QAAQ,KAAK,CAAC,CAChB,CAGF,CAAC,EAED,SAAS,cAAc,eAAe,EAAE,iBAAiB,QAAS,SAAY,CAC5ED,EAAc,OAAO,CACvB,CAAC",
  "names": ["CancelError", "message", "makeRequest", "method", "url", "xhr", "req", "resolve", "reject", "inputEl", "resultEl", "showResult", "val", "req", "makeRequest", "data", "cancelablePromise", "func", "reqObj", "promise", "e", "promiseResult", "doComplexShit", "data1", "data2", "CancelError"]
}
